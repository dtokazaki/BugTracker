<!DOCTYPE>
<html>
<head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
</head>
<body style="margin:25">
	<a href = "table.html">
        <button type="button" class="btn btn-default ">Table</button></a>    
	<a href = "dynamoForm.html">
	  <button type="button" class="btn btn-default">Home</button></a>
  <div class="btn-group" role="group" aria-label="...">
	  <a href = "tester.html" class="btn btn-default disabled">Tester</a>
	  <a href="developer.html" class="btn btn-default">Developer</a>
	  <a href="manager.html" class="btn btn-default">Manager</a>
  </div>
  <br>
  <br>
<script type="text/javascript">
// LOCAL DATABASE:
// AWS.config.update({
//   region: "us-west-2",
//   endpoint: 'http://localhost:8000',
//   accessKeyId: "fakeMyKeyId",
//   secretAccessKey: "fakeSecretAccessKey"
// });

// NON-LOCAL DATABASE:
// AWS.config.update({
//   region: "us-west-2",
//  });

// AWS.config.credentials = new AWS.CognitoIdentityCredentials({
// 	IdentityPoolId: "us-west-2:8b603897-8374-45e1-80be-3f8781f822b9",
// 	RoleArn: "arn:aws:iam::425648465739:role/Cognito_DynamoPoolUnauthorized"
// });
// AWS.config.credentials.get(function(){
// 	var accessKeyId = AWS.config.credentials.accessKeyId;
// 	var secretAccessKey = AWS.config.credentials.secretAccessKey;
// });

// var dynamodb = new AWS.DynamoDB();
// var docClient = new AWS.DynamoDB.DocumentClient();

function updateItem(bugID,dev,decision,table) {
	var y = decision;
	var id = bugID;
	var devName = dev;
	if(devName==" " && decision=="fixed") y = "nonissue";

	var params = {
		TableName:table,
		Key:{
			"id": parseInt(id)
		},
		UpdateExpression: "set stage = :s",
		ExpressionAttributeValues:{
			":s": y
		},
		ReturnValues:"UPDATED_NEW"
	};

	docClient.update(params, function(err, data) {
		if (err) {
			//document.getElementById('textarea').innerHTML = "Unable to update item: " + "\n" + JSON.stringify(err, undefined, 2);
		} else {
			//document.getElementById('textarea').innerHTML = "UpdateItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2);
		}
	});
}
function updateBug(bugID,dev,decision) {
	var y = decision;
	var id = bugID;
	var devName = dev;
	updateItem(bugID,dev,decision,"Bugs");
	if (y=="nonissue") {
		deleteItem(id,"Testers");
	}
	else if (y=="fixed") {
		deleteItem(id,"Testers");
		deleteItem(id,"Managers");
	}
	else{
		var getParams = {
			TableName : "Bugs",
			Key : {
				"id": parseInt(id)
			}
		};
		docClient.get(getParams,function(err,data) {
			if(err) {
				//document.getElementById('textarea').innerHTML = "Unable to read item: " + "\n" + JSON.stringify(err, undefined, 2);

			} else {
				if(data.Item.dev==" ") table = "Managers";
				else {
					table = "Developers"
					updateItem(bugID,dev,decision,"Managers");
				}
				console.log(data.Item);
				var newParams = {
					TableName : table,
					Item : {
						"id" : data.Item.id,
						"descr": data.Item.descr["S"],
						"doing": data.Item.doing["S"],
						"dev": data.Item.dev,
						"stage": "issue"
					}
				}
				docClient.put(newParams, function(err, data) {
					if (err) {
						//document.getElementById('textarea').innerHTML = "Unable to add item: " + "\n" + JSON.stringify(err, undefined, 2);
					} else {
						//document.getElementById('textarea').innerHTML = "PutItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2);
					}
				});
			}
		});
		deleteItem(id,"Testers");
		
	}
}

function deleteItem(bugID,tname) {
	var id = bugID;
	var table = tname;
	var params = {
		TableName:table,
		Key:{
			"id":parseInt(id)
		}
	};
	docClient.delete(params, function(err, data) {
		if (err) {
			//document.getElementById('textarea').innerHTML = "Unable to delete item: " + "\n" + JSON.stringify(err, undefined, 2);
		} else {
			//document.getElementById('textarea').innerHTML = "DeleteItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2);
		}
	});
}
function testerData(tester) {
	
	 var data = "tester="+ tester;
	 
	 $.ajax({
		url: "https://052stnmylg.execute-api.us-west-1.amazonaws.com/firstTest/getTester",
		data: data,
		type: "GET",
		beforeSend: function(xhr) {
			console.log(data);
			xhr.setRequestHeader('x-api-key', 'NZLlovyCrO83qyPR4IXNl7ARqF9nLaFn2EZp7AlL');
		},
		success: function (data) {
			//alert("Success!" + JSON.stringify(data))
			console.log(data); 

			var severityLevel = ["blocker","critical","major","minor","cosmetic"];
			
			var myTableDiv = document.getElementById("testTable");
			var body = document.body;
			var tbl = document.createElement('table');

			tbl.style.width  = '900';
			tbl.style.border = '1px solid black';
			var tr = tbl.insertRow();
			
			var td1 = tr.insertCell();
			td1.appendChild(document.createTextNode("ID"));
			td1.style.border = '2px solid black';
			
			var td2 = tr.insertCell();
			td2.appendChild(document.createTextNode("Description"));
			td2.style.border = '2px solid black';
			
			var td3 = tr.insertCell();
			td3.appendChild(document.createTextNode("What you were doing"));
			td3.style.border = '2px solid black';
			
			var td4 = tr.insertCell();
			td4.appendChild(document.createTextNode("Developer"));
			td4.style.border = '2px solid black';
			
			var td5 = tr.insertCell();
			td5.appendChild(document.createTextNode("Status"));
			td5.style.border = '2px solid black';
			
			var td6 = tr.insertCell();
			td6.appendChild(document.createTextNode("Severity"));
			td6.style.border = '2px solid black';

			var td7 = tr.insertCell();
			td7.style.border = '2px solid black';

			var i = 0;
		
			data.forEach(function(bug) {
				var id = bug['id'];

				//id
				var tr = tbl.insertRow();
				i++;
				var td1 = tr.insertCell();
				td1.appendChild(document.createTextNode(bug['code']));
				td1.style.border = '1px solid black';

				//description
				var td2 = tr.insertCell();
				td2.appendChild(document.createTextNode(bug['description']));
				td2.style.border = '1px solid black';

				//what client was doing
				var td3 = tr.insertCell();
				td3.appendChild(document.createTextNode(bug['details']));
				td3.style.border = '1px solid black';
				
				//dev name
				var td4 = tr.insertCell();
				var devName = bug['developer'];
				if(devName==" ") devName = "not assigned";
				td4.appendChild(document.createTextNode(devName));
				td4.style.border = '1px solid black';
				
				//status
				var td5 = tr.insertCell();
				td5.appendChild(document.createTextNode(bug['status']));
				td5.style.border = '1px solid black';
				
				//tester's choice
				var td6 = tr.insertCell();
				var div1 = document.createElement('div');
				div1.setAttribute("class","btn-group");
				var button = document.createElement('button');
				var sevChosen = true;
				button.setAttribute("data-toggle","dropdown");
				button.setAttribute("class","btn btn-default dropdown-toggle");
				if(bug['severity']==" ") sevChosen = false;
				if(sevChosen) button.innerHTML = bug['severity'];
				else button.innerHTML = "Severity";
				/*if(devChosen) {
					button.setAttribute("class","btn btn-default dropdown-toggle disabled");
					button.innerHTML = bug['developer'];
				}*/
				var div2 = document.createElement('div');
				div2.setAttribute("class","dropdown-menu");
				div2.style.minWidth="80px";
				div2.style.minHeight="100px";
				div2.style.textAlign="center";
				var i;
				for (i=0; i < severityLevel.length; i++) {
					var level = severityLevel[i];
					var sevButton = document.createElement('button');
					sevButton.style.padding='3px 3px';
					sevButton.style.width='80px';
					sevButton.innerHTML = level;
					sevButton.setAttribute("class","dropdown-item");
					sevButton.addEventListener('click', function() {
						var chosenLevel = this.innerHTML;
						// assign to developer

						//updateItem(bug.id, chosenName,"Managers");
						//updateItem(bug.id, chosenName,"Bugs");

						this.parentNode.parentNode.children[1].innerHTML = chosenLevel;
						//this.parentNode.parentNode.children[1].setAttribute("class","btn btn-default dropdown-toggle disabled");
						//td4.innerHTML = chosenLevel;
					});
					div2.appendChild(sevButton);
					div1.appendChild(div2);
				}
				div1.appendChild(button);				
				td6.appendChild(div1);
				td6.style.border = '1px solid black';
				td6.style.textAlign = "center";

				var td7 = tr.insertCell();
				var button1 = document.createElement('button');
				button1.addEventListener('click', function() {
					// tester to manager
					// if assigned tester to developer
					tbl.deleteRow(this.parentNode.parentNode.rowIndex);
					i--;
				});
				button1.innerHTML = "issue";
				var button2 = document.createElement('button');
				button2.addEventListener('click', function() {
					//tester fixed
					tbl.deleteRow(this.parentNode.parentNode.rowIndex);
					i--;
				});
				button2.innerHTML = "fixed";
				td7.appendChild(button1);
				td7.appendChild(button2);
				td7.style.border = '1px solid black';
				td7.style.textAlign = "center";
			}); 
			body.appendChild(tbl);
		}

	})

}

testerData("tester");
</script>


</body>
</html>
